FROM node:20

# Install development tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    git curl bash sudo nano vim \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

# Install Claude Code
RUN npm install -g @anthropic-ai/claude-code@latest

# Setup MCP servers after Claude installation
RUN claude mcp add glootie -- npx -y mcp-glootie@latest && \
    claude mcp add vexify -- npx -y mcp-vexify@latest && \
    claude mcp add playwright -- npx @playwright/mcp@latest

# Create isolated workspace script with cleanup
RUN echo '#!/bin/bash\nset -e\n\necho "🚀 Starting SandboxBox with Claude Code in isolated environment..."\necho "📁 Working directory: /workspace"\necho "🎯 This is an isolated copy of your repository"\n\n# Cleanup function for temporary files\ncleanup_temp_files() {\n    echo "🧹 Cleaning up temporary files..."\n    find /tmp -user root -name "claude-*" -type f -delete 2>/dev/null || true\n    find /tmp -user root -name "*.tmp" -type f -delete 2>/dev/null || true\n    find /var/tmp -user root -name "claude-*" -type f -delete 2>/dev/null || true\n}\n\n# Set up cleanup trap\ntrap cleanup_temp_files EXIT INT TERM\n\nif [ -d "/workspace/.git" ]; then\n    echo "✅ Git repository detected in workspace"\n    echo "📋 Current status:"\n    git status\n    echo ""\n    echo "🔧 Starting Claude Code..."\n    echo "💡 Changes will be isolated and will NOT affect the original repository"\n    echo "📝 To save changes, use git commands to commit and push before exiting"\n    echo "🔧 MCP servers: glootie, vexify, playwright"\n    exec claude\nelse\n    echo "❌ Error: /workspace is not a valid git repository"\n    exit 1\nfi' > /usr/local/bin/start-isolated-sandbox.sh && chmod +x /usr/local/bin/start-isolated-sandbox.sh

CMD ["/usr/local/bin/start-isolated-sandbox.sh"]